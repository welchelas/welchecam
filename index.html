<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>C치mara con permiso para todas al inicio</title>
<style>
  body, html { margin:0; padding:0; height:100%; background:black; display:flex; justify-content:center; align-items:center; overflow:hidden; }
  video { width: 100vw; height: 100vh; object-fit: cover; transition: opacity 0.3s ease; }
  #controls { position: fixed; top: 10px; left: 10px; display: flex; gap: 10px; z-index: 1000; }
  button { background: rgba(0,0,0,0.5); color: white; border: none; padding: 10px 15px; font-size: 16px; border-radius: 5px; cursor: pointer; }
  button:active { background: rgba(255,255,255,0.3); }
</style>
</head>
<body>

<video id="video" autoplay playsinline muted></video>

<div id="controls">
  <button id="switchCameraBtn" title="Cambiar c치mara">游닝</button>
  <button id="muteBtn" title="Silenciar / activar micr칩fono">游꿗</button>
</div>

<script>
  const video = document.getElementById('video');
  const switchCameraBtn = document.getElementById('switchCameraBtn');
  const muteBtn = document.getElementById('muteBtn');

  let isMuted = false;
  let streams = [];
  let currentStreamIndex = 0;

  async function getAllVideoInputs() {
    const devices = await navigator.mediaDevices.enumerateDevices();
    return devices.filter(d => d.kind === 'videoinput');
  }

  async function requestPermissionsForAllCameras() {
    const videoInputs = await getAllVideoInputs();
    streams = [];

    for (let i = 0; i < videoInputs.length; i++) {
      const deviceId = videoInputs[i].deviceId;
      try {
        // Pedimos permiso y guardamos stream, pero no lo mostramos a칰n
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { deviceId: { exact: deviceId } },
          audio: true
        });
        streams.push(stream);
        // Opcional: cerramos inmediatamente para liberar recursos pero mantenemos referencia
        // NO cerramos para poder cambiar r치pido sin pedir permiso otra vez
      } catch (e) {
        console.warn('No se pudo acceder a la c치mara:', deviceId, e);
      }
    }

    if(streams.length === 0){
      alert('No se detectaron c치maras o no se pudo acceder a ninguna.');
    }
  }

  function playStream(index) {
    if(streams.length === 0) return;
    if (video.srcObject) {
      video.srcObject.getTracks().forEach(t => t.stop());
    }
    currentStreamIndex = index;
    video.srcObject = streams[index];

    const audioTrack = streams[index].getAudioTracks()[0];
    if(audioTrack) audioTrack.enabled = !isMuted;
  }

  switchCameraBtn.addEventListener('click', () => {
    if(streams.length < 2) {
      alert('No hay otra c치mara para cambiar');
      return;
    }
    let nextIndex = (currentStreamIndex + 1) % streams.length;
    playStream(nextIndex);
  });

  muteBtn.addEventListener('click', () => {
    if (streams.length === 0) return;
    const audioTrack = streams[currentStreamIndex].getAudioTracks()[0];
    if (!audioTrack) return;

    isMuted = !isMuted;
    audioTrack.enabled = !isMuted;
    muteBtn.textContent = isMuted ? '游댆' : '游꿗';
  });

  async function init() {
    await requestPermissionsForAllCameras();
    if(streams.length > 0) {
      playStream(0);
    }
  }

  init();
</script>

</body>
</html>
